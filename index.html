<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV7V8P3B6L"></script>
<script>
  
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NV7V8P3B6L');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InstantPDFSearch üìÑüîç</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f5f7fa; }
    h1 { font-size: 2em; text-align: center; }
    .uploader { margin-top: 2rem; text-align: center; }
    .results { margin-top: 2rem; }
    .snippet { background: #fff; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .highlight { background: yellow; font-weight: bold; }
    .status { margin-top: 1rem; text-align: center; font-size: 1.1rem; color: #444; }
    input[type="file"] { display: block; margin: 1rem auto; }
    input[type="text"] { padding: 0.5rem; width: 80%; margin: 1rem auto; display: block; }
  </style>
</head>
<body>
  <h1>InstantPDFSearch üìÑüîç</h1>
  <div class="uploader">
<input type="file" id="pdfFile" accept="application/pdf" onchange="document.getElementById('pdfUrl').value = '';" />
   <p style="margin: 0.5rem 0; font-weight: bold;">‚Äî or ‚Äî</p>
    <input type="text" id="pdfUrl"
       placeholder="Paste PDF URL here..."
       pattern="https?://.*\.(pdf|ashx)"
       title="Must start with http:// or https:// and end with .pdf or .ashx"
       oninput="document.getElementById('pdfFile').value = '';" />
    <button onclick="handlePDF()">üöÄ Scan PDF</button>
    <div class="status" id="status"></div>
  </div>
  <div id="searchArea" style="display:none;">
    <input type="text" id="searchInput" placeholder="Enter keyword to search..." oninput="searchInText()" />
  </div>
  <div id="contextSliderWrapper" style="display: none; margin: 1rem auto; text-align: center;">
<label for="contextSlider"><strong>Expand context (lines):</strong></label>
 <input type="range" id="contextSlider" min="0" max="20" value="0" step="1" oninput="updateContextLines(this.value)">
<span id="contextValue">0</span> lines

</div>

  <div class="results" id="results"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const ENABLE_LOGGING = true; // üëÅÔ∏è Set to false to disable logging
    let fullText = "";

    function log(...args) {
      if (ENABLE_LOGGING) console.log(...args);
    }

  function updateContextLines(value) {
  contextLines = parseInt(value, 10);
  document.getElementById("contextValue").textContent = contextLines;
  searchInText(); // re-render with new context
}

  async function handlePDF() {
  const file = document.getElementById('pdfFile').files[0];
  const url = document.getElementById('pdfUrl').value.trim();
  const isValidPdfUrl = /^https?:\/\/.+\.(pdf|ashx)$/i.test(url);
if (url && !isValidPdfUrl) {
  alert("Please enter a valid URL ending in .pdf or .ashx");
  return;
}

  const status = document.getElementById('status');
  const results = document.getElementById('results');
  results.innerHTML = '';
  fullText = '';
  status.textContent = 'üì• Loading PDF...';

  try {
    let loadingTask;

    if (file) {
      if (file.size > 50 * 1024 * 1024) {
        alert("File exceeds 50MB limit.");
        return;
      }
      const reader = new FileReader();
      reader.onload = async (e) => {
        const typedarray = new Uint8Array(e.target.result);
        await processPDF(typedarray);
      };
      reader.readAsArrayBuffer(file);
    } else if (url) {
      let proxyUrl = url;

      // Wake-up notice for Render cold start
      if (!url.endsWith('.pdf')) {
        status.textContent = '‚è≥ Waking up the PDF services‚Ä¶ this may take ~20‚Äì30 seconds.';
        proxyUrl = `https://instantpdfsearch.onrender.com/api/fetchpdf?url=${encodeURIComponent(url)}`;
      }

      loadingTask = pdfjsLib.getDocument(proxyUrl);
      const pdf = await loadingTask.promise;
      await extractTextFromPDF(pdf);
    } else {
      alert("Please upload a file or paste a PDF URL.");
    }
  } catch (err) {
    log("Error processing PDF:", err);

    if (err?.message?.includes("Unexpected server response (404)") || err?.status === 404) {
      if (url.endsWith('.ashx')) {
        status.textContent = '‚ùå Could not fetch .ashx file (404). Double-check the IMF URL for typos.';
      } else {
        status.textContent = '‚ùå PDF not found (404). Please check the URL.';
      }
    } else if (err?.message?.includes("Failed to fetch") || err?.message?.includes("NetworkError")) {
      status.textContent = '‚ùå Network error. Please check your internet connection.';
    } else if (err?.message?.includes("timeout")) {
      status.textContent = '‚ùå Request timed out. The server may be waking up or the URL may be unreachable.';
    } else if (err?.message?.includes("Invalid PDF structure")) {
      status.textContent = '‚ùå This file is not a valid PDF.';
    } else {
      status.textContent = `‚ùå Error: ${err?.message || 'Unknown error'}`;
    }
  }
}




    async function processPDF(typedarray) {
      const status = document.getElementById('status');
      const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
      await extractTextFromPDF(pdf);
    }

    async function extractTextFromPDF(pdf) {
      const status = document.getElementById('status');
      fullText = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(' ');
        fullText += `\n[PAGE ${i}]\n` + pageText;
        status.textContent = `üëÄ Reading page ${i} of ${pdf.numPages}...`;
      }

      document.getElementById('searchArea').style.display = 'block';
      status.textContent = `‚úÖ Done reading ${pdf.numPages} pages.`;
      log("Extracted text:", fullText.substring(0, 300));
    }

  let contextLines = 0; // slider starts at 0
  const defaultContextChars = 80; // matches original behavior

    
 function searchInText() {
  const query = document.getElementById('searchInput').value.trim();
  const results = document.getElementById('results');
  const sliderWrapper = document.getElementById('contextSliderWrapper');

  results.innerHTML = '';

  if (!query) {
    sliderWrapper.style.display = 'none';
    return;
  }

  sliderWrapper.style.display = 'block';
  document.getElementById('contextValue').textContent = contextLines;

  const snippets = [];
  const lines = fullText.split('\n');

  const regex = new RegExp(`(.{0,80})(${query})(.{0,80})`, 'gi');
  let match;

  while ((match = regex.exec(fullText)) !== null) {
    const matchText = match[0];
    const matchIndex = match.index;

    // Find which line the match is on
    let charCount = 0;
    let lineIndex = -1;

    for (let i = 0; i < lines.length; i++) {
      charCount += lines[i].length + 1; // +1 for '\n'
      if (charCount > matchIndex) {
        lineIndex = i;
        break;
      }
    }

    if (lineIndex === -1) continue;

    const start = Math.max(0, lineIndex - contextLines);
    const end = Math.min(lines.length - 1, lineIndex + contextLines);

    const snippetText = lines.slice(start, end + 1).join('<br>');
    const highlighted = snippetText.replace(
      new RegExp(`(${query})`, 'gi'),
      `<span class='highlight'>$1</span>`
    );

    const pageMatch = fullText.lastIndexOf("[PAGE ", matchIndex);
    const pageLabel = fullText.substring(pageMatch, fullText.indexOf("\n", pageMatch));

    snippets.push(`<div class='snippet'><strong>${pageLabel}</strong><br>${highlighted}</div>`);
  }

  if (snippets.length === 0) {
    results.innerHTML = "<p>No results found.</p>";
    sliderWrapper.style.display = 'none';
  } else {
    results.innerHTML = `<p>üîç Found ${snippets.length} match(es):</p>` + snippets.join('');
  }
}


  </script>
</body>
</html>
